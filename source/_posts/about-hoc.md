---
title: é«˜é˜¶ç»„ä»¶
date: 2021-03-28 11:34:41
tags:
---

ä¸çŸ¥é“ä½ åœ¨å·¥ä½œä¸­æœ‰æ²¡æœ‰æ¥è§¦è¿‡é«˜é˜¶ç»„ä»¶ï¼Œå¾ˆå¤šæ—¶å€™æˆ‘æ˜¯æ²¡ä»€ä¹ˆæœºä¼šå»å†™ä¸€ä¸ªé«˜é˜¶ç»„ä»¶ï¼Œæ‰€ä»¥è¿™ä¸ªä¸œè¥¿åœ¨æˆ‘è¿™é‡Œå°±æ˜¯ä¸€ä¸ªç†è®ºçŸ¥è¯†å‚¨å¤‡ï¼Œæˆ–è®¸åªä¼šåœ¨é¢è¯•æˆ–è€…æ˜¯çœ‹å…¶ä»–äººä»£ç çš„æ—¶å€™æ‰ä¼šå»çœ‹çœ‹ã€‚å‰ä¸¤å¤©æŸ¥äº†ä¸€ä¸ªé«˜é˜¶ç»„ä»¶å†…çš„ bugï¼ŒæŸ¥ç€æŸ¥ç€æˆ‘å°±çªç„¶åœ¨æ€è€ƒï¼Œä¸ºä»€ä¹ˆä¸€ä¸ªå¾ˆç®€å•çš„åŠŸèƒ½ï¼Œè¦ç”¨é«˜é˜¶ç»„ä»¶æ¥å®ç°ï¼Œé«˜é˜¶ç»„ä»¶èƒ½ä¸ºæˆ‘ä»¬å¸¦æ¥ä»€ä¹ˆå‘¢ï¼Ÿ

<!-- more -->

äº‹æƒ…æ˜¯è¿™æ ·çš„ï¼Œå‰ä¸¤å¤©åœ¨åšä¸€ä¸ªç´§æ€¥éœ€æ±‚ï¼Œéœ€æ±‚æœ¬èº«ä¸å¤æ‚ï¼Œä½†æ˜¯è®¾è®¡ç”¨åˆ°äº†ã€æ–°æ‰‹æŒ‡å¼•ã€‘è¿™ä¸ªäº¤äº’ç»„ä»¶ï¼Œè¿™ä¸ªç»„ä»¶çš„åœºæ™¯ç›¸ä¿¡å¤§å®¶éƒ½è§è¿‡ï¼Œæ¯”å¦‚ä½ æ‰“å¼€ä¸€ä¸ªæ–°çš„æ¸¸æˆï¼Œè‚¯å®šæœ‰å¾ˆå¤š npc æ¥æŒ‡å¼•ä½ åšä¸€äº›å†…å®¹ï¼ŒæŠ“ä½ä½ çœ¼çƒçš„åŒæ—¶ï¼Œåˆä¼šå¼ºåˆ¶è®©ä½ å­¦ä¹ æŸä¸ªåŠŸèƒ½çš„ä½¿ç”¨ã€‚æˆ‘ä»¬è¿™ä¸ªç»„ä»¶æ˜¯ä¸€ä¸ªç®€åŒ–ç‰ˆæœ¬ï¼Œå¤§æ¦‚å°±æ˜¯å½“ä½ ä½œä¸ºä¸€ä¸ªé¦–æ¬¡ä½¿ç”¨æŸä¸ª äº®çœ¼/éš¾ä»¥æ“ä½œ çš„åŠŸèƒ½çš„ç”¨æˆ·æ—¶ï¼Œç³»ç»Ÿä¼šé«˜äº®å‡ºè¯¥åŠŸèƒ½åŒºåŸŸï¼Œå…¶ä»–åŒºåŸŸç”¨ä¸€ä¸ªè’™å±‚é®ç›–ï¼Œä¸”åœ¨é«˜äº®é™„è¿‘æœ‰ä¸€ä¸ªå‹å¥½çš„æç¤ºæ–‡æ¡ˆï¼Œå°±åƒä¸‹é¢è¿™ä¸ªå›¾ä¸€æ ·ï¼š
![img](1.jpg)

~~è¯´åˆ°è¿™ä¸ªç´§æ€¥éœ€æ±‚å°±éƒé—·ï¼Œæ€ä¹ˆä¹Ÿæ²¡æƒ³åˆ° 315 å¹³å°ç‚¹åçš„å‡ ä¸ªæŠ•ç®€å†çš„ç½‘ç«™ï¼Œè¢« cue è¯´æ³„éœ²å®¢æˆ·éšç§çš„è¿™ä¸ªäº‹æƒ…ï¼Œå±…ç„¶ä¼šæ³¢åŠåˆ°æˆ‘çš„å·¥ä½œï¼Œä¸å¾—ä¸ä¸ºäº†è¿™ä¸ªéšç§è€ŒåŠ ç­è¡¥å……äº†ä¸€ç³»åˆ—åŠŸèƒ½ã€‚ã€‚TAT~~

å—¯ï¼Œæ€è€ƒä¸€ä¸‹ï¼Œå¦‚æœè®©ä½ å®ç°ä¸€ä¸ªè¿™æ ·çš„åŠŸèƒ½ï¼Œä½ ä¼šæ€ä¹ˆåšï¼Ÿ

ğŸ™‹ğŸ»â€â™€ï¸ æˆ‘å…ˆæ¥ï¼Œè¿™ä¸ªåŠŸèƒ½åœ¨ç§»åŠ¨ç«¯å¹¶æ²¡æœ‰å®ç°è¿‡ï¼Œæ‰€ä»¥æˆ‘è‡ªå·±å†™äº†ä¸€ä¸ªç§»åŠ¨ç«¯çš„é€»è¾‘ï¼Œæˆ‘çš„æ€è·¯å°±æ˜¯å¿«è€Œç®€çš„æ˜¾ç¤ºï¼Œå…ˆå†™ä¸€ä¸ª `<Guide/>` ç»„ä»¶ï¼Œåˆ©ç”¨ `redux` å­˜å‚¨è¦å±•ç¤ºçš„æŒ‡å¼• `id`ï¼Œç„¶ååœ¨å¯¹åº”çš„è¦å±•ç¤ºç•Œé¢ä¸Šæ ¹æ®ä¸€ç³»åˆ—åˆ¤æ–­ï¼Œç„¶åè°ƒç”¨è¿™ä¸ªå…¬å…±çš„ `<Guide/>` ç»„ä»¶å±•ç¤ºå°±å¥½ã€‚

å¤§æ¦‚æ˜¯ä¸‹é¢è¿™æ®µä»£ç é€»è¾‘ï¼š

```js
//action.js
 function fetchGuideId() {
  return (dispatch) =>
    request
    .get('/api/getGuideId')
    .then(guideIds) =>
      dispatch({
        type: 'REPLACE_GUIDE_IDS',
        payload: { guideIds }
      })
}

// reducer.js
function guides(state = {}, action) {
  switch (action.type) {
    case "REPLACE_GUIDE_IDS": {
      const { guideIds } = action.payload;
      return { ...state, guideIds };
    }

    default:
      return state;
  }
}
```

```js
// App.js
import React from "react";
import Guide from "./Guide";

class App extends React.Component {
  constructor(props) {
    super(props);
  }

  registerGuide = () => {
    const position = this.guideRef.getBoundingClientRect();
    // æ ¹æ® position çš„ä¸€ç³»åˆ—ä¿¡æ¯å±•ç¤ºguideçš„ä½ç½®
    return <Guide position={position} />;
  };

  render() {
    const someGuideId = "someGuideId";
    // åˆ¤æ–­æ˜¯é¦–æ¬¡ä½¿ç”¨æ­¤åŠŸèƒ½çš„ç”¨æˆ·
    const showGuide = this.props.guideIds.includes(someGuideId);
    return (
      <div>
        <div ref={(ref) => (this.guideRef = ref)}>
          {/* è¦ç»‘å®šé«˜äº®æ˜¾ç¤ºguideçš„ */}
        </div>
        {showGuide && this.registerGuide()}
        <div>{/* å…¶ä»–çš„é¡µé¢åœ†åº¦ */}</div>
      </div>
    );
  }
}

export default App;
```

å—¯ã€‚å¤§æ¦‚å°±æ˜¯ä¸Šé¢é‚£ä¸ªæ ·å­ï¼ŒåŸºæœ¬ä¸Šå°±å·²ç»æ»¡è¶³çš„éœ€æ±‚åœºæ™¯äº†ã€‚

å½“ç„¶å•¦ï¼Œçœ‹åˆ°è¿™ä¸ªæ ‡é¢˜ä½ å°±çŸ¥é“ï¼Œè¿™ä¸ªç»„ä»¶æœ€ç»ˆåœ¨æˆ‘ä»¬çš„ç³»ç»Ÿ pc ç«¯é‡Œè¢«è®¾è®¡æˆäº†ä¸€ä¸ªé«˜é˜¶ç»„ä»¶ï¼Œä¸€ä¸ªæ¯”è¾ƒå¤§(å¤§æ¦‚ 329 è¡Œï¼Œè¿˜è¡Œ)ä¸”å¤æ‚çš„ç»„ä»¶ï¼Œè¿˜æœ‰ç‚¹ç‚¹ bug ğŸ¤¦ğŸ»â€â™€ï¸

![img](2.jpg)

ç„¶åæˆ‘ä¸€è¾¹æ”¹ç€ bugï¼Œä¸€è¾¹æ€è€ƒï¼Œé«˜é˜¶ç»„ä»¶æ˜¯ä»€ä¹ˆï¼Œè®¾è®¡ä¹‹åˆåˆ°åº•æ˜¯ä¸ºäº†è§£å†³ä»€ä¹ˆç—›ç‚¹ï¼Œçœ‹äº†ä¸‹å®˜æ–¹æ–‡æ¡£æ˜¯è¿™ä¹ˆå®šä¹‰çš„ï¼š

> é«˜é˜¶ç»„ä»¶ï¼ˆHOCï¼‰æ˜¯ React ä¸­ç”¨äºå¤ç”¨ç»„ä»¶é€»è¾‘çš„ä¸€ç§é«˜çº§æŠ€å·§ã€‚HOC è‡ªèº«ä¸æ˜¯ React API çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒæ˜¯ä¸€ç§åŸºäº React çš„ç»„åˆç‰¹æ€§è€Œå½¢æˆçš„è®¾è®¡æ¨¡å¼
> å…·ä½“è€Œè¨€ï¼Œ**é«˜é˜¶ç»„ä»¶æ˜¯å‚æ•°ä¸ºç»„ä»¶ï¼Œè¿”å›å€¼ä¸ºæ–°ç»„ä»¶çš„å‡½æ•°**ã€‚

```js
const EnhancedComponent = higherOrderComponent(WrappedComponent);
```

> ç»„ä»¶æ˜¯å°† `props` è½¬æ¢ä¸º UIï¼Œè€Œé«˜é˜¶ç»„ä»¶æ˜¯å°†ç»„ä»¶è½¬æ¢ä¸ºå¦ä¸€ä¸ªç»„ä»¶ã€‚
> HOC åœ¨ React çš„ç¬¬ä¸‰æ–¹åº“ä¸­å¾ˆå¸¸è§ï¼Œä¾‹å¦‚ Redux çš„ `connect` å’Œ `Relay` çš„`createFragmentContainer`ã€‚

è¯¶ï¼Ÿè¯´åˆ°è¿™é‡Œçš„è¯ï¼Œé‚£å°±ä¼šå‘ç°ï¼Œå…¶å®ä½ å·²ç»æ‚„æ— å£°æ¯çš„ä½¿ç”¨è¿‡å¾ˆå¤šçš„é«˜é˜¶ç»„ä»¶äº†ï¼Œæ¯”å¦‚è¯´ `connect`ã€‚ç›¸ä¿¡å¤§å®¶åªè¦æ˜¯ç”¨äº† React çš„åŸºæœ¬ä¸Šéƒ½æœ‰ç”¨è¿‡è¿™ä¸ª HOCã€‚é‚£ä¹ˆä»”ç»†çœ‹æ–‡æ¡£å°±ä¼šç†è§£é«˜é˜¶ç»„ä»¶çš„æ„ä¹‰ï¼Œå¾ˆå¤šæ—¶å€™æˆ‘ä»¬ä¼šé‡åˆ°ä¸€äº›å…¬å…±çš„ UI+é€»è¾‘ï¼Œæ¯”å¦‚è¯´ä¸Šé¢æåˆ°çš„æ–°æ‰‹æŒ‡å¼•ï¼Œå½“ç„¶å¯¹äºç•Œé¢ï¼Œæˆ‘ä»¬å¯ä»¥å°è£…å‡ºä¸€ä¸ªå…¬å…±çš„ `Guide` ç»„ä»¶ï¼Œä½†æ˜¯åœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œä½ è¿˜æ˜¯éœ€è¦å†™å¾ˆå¤§ä¸€æ®µå…¬å…±çš„é€»è¾‘ï¼Œå»åˆ¤æ–­ä»€ä¹ˆæ—¶å€™æ³¨å†Œã€ä»€ä¹ˆæ—¶å€™æ¸²æŸ“ã€æ¸²æŸ“åˆ°ç•Œé¢çš„ä»€ä¹ˆèŠ‚ç‚¹ï¼Œè¿™æ—¶å€™ï¼ŒæŠŠè¿™ä¸€æ•´å¥—çš„ UI+é€»è¾‘æŠ½ç¦»å‡ºæ¥åšä¸€ä¸ªé«˜é˜¶ç»„ä»¶ï¼Œç„¶ååœ¨ä½¿ç”¨çš„æ—¶å€™å»ä¼ å…¥ä¸€äº›çº¦å®šå¥½çš„å‚æ•°å°±å¯ä»¥èŠ‚çœå¾ˆå¤šçš„æ—¶é—´äº†ã€‚

é‚£è¿˜æ˜¯è¯´å›è¿™ä¸ªæ–°æ‰‹æŒ‡å¼•ç»„ä»¶ï¼Œè¿™æ—¶å€™å°±å¾ˆé€‚åˆæŠ½ç¦»å‡ºä¸€ä¸ªé«˜é˜¶ç»„ä»¶ï¼Œæ¥ç»Ÿä¸€åˆ¤æ–­ä»€ä¹ˆæ—¶å€™æ˜¾ç¤ºè¿™ä¸ª guideï¼Œtalk is less ï¼Œshow me the codeã€‚

```js
// withGuides.js
import React from "react";
import Guide from "./Guide";

/**
 * Guide HOC
 * @return {React.ComponentClass<T>}
 */
export function withGuides(WrappedComponent, guides) {
  class EnhanceWithGuides extends React.Component {
    constructor(props) {
      super(props);

      this.mountNode = null;
    }

    /**
     * åˆ¤æ–­wrapperçš„ç»„ä»¶guidesä¸­æ˜¯å¦æœ‰guideIdå¯ä»¥æ›¿æ¢å½“å‰guideId,
     * å¦‚æœæœ‰,åˆ™è¿”å›å¯¹åº”Id,æ²¡æœ‰åˆ™è¿”å›null
     */
    getCanLoadGuideId(availableGuideIdSet, currentGuideId) {
      return availableGuideIdSet.has(currentGuideId) ? currentGuideId : null;
    }

    renderGuide = () => {
      if (!this.mountNode) {
        return;
      }

      const { currentGuideId, availableGuideIdSet } = this.props;

      const canLoadGuideId = this.getCanLoadGuideId(
        availableGuideIdSet,
        currentGuideId
      );

      // åˆ¤æ–­ä¸€äº›æƒ…å†µ
      if (currentGuide && currentStep && dataReady && targetDOMReady) {
        // å½“å‰guideçš„æŸä¸ªstepå°±æ˜¯è¦è¢«å±•ç¤ºçš„stepï¼Œåˆ™render guide
        ReactDOM.render(<Guide {...this.props} />, this.mountNode);
      } else {
        // å¦åˆ™æ’¤æ‰guide
        ReactDOM.unmountComponentAtNode(this.mountNode);
      }
    };

    componentDidMount() {
      if (!this.mountNode) {
        this.mountNode = document.createElement("div");
      }
      document.body.appendChild(this.mountNode);
      this.renderGuide();
    }

    componentDidUpdate() {
      this.renderGuide();
    }

    componentWillUnmount() {
      if (!this.mountNode) {
        return;
      }
      try {
        // ä¸è¦å¿˜è®°å¸è½½
        ReactDOM.unmountComponentAtNode(this.mountNode);
        document.body.removeChild(this.mountNode);
      } catch (e) {
        // do nothing.
      }
    }

    render() {
      /**
       * è¿™é‡Œå°† renderGuide æ–¹æ³•ä¼ ç»™å­ç»„ä»¶ æ˜¯ä¸ºäº†è§£å†³æ˜¾ç¤ºæ–°æ‰‹æŒ‡å¼•çš„åœ°æ–¹å¹¶éå­ç»„ä»¶ didMount å°±å‡ºç°
       * å¯ä»¥åœ¨éœ€è¦æ¸²æŸ“æŒ‡å¼•çš„æ—¶æœº å†æ¬¡è°ƒç”¨ renderGuide æ–¹æ³•
       */
      return (
        <WrappedComponent {...this.props} renderGuide={this.renderGuide} />
      );
    }
  }

  return EnhanceWithGuides;
}
```

æœ‰äº†è¿™ä¸ªé«˜é˜¶ç»„ä»¶ä¹‹åï¼Œä½ ä¹‹åå°±å¯ä»¥ç›´æ¥ä¼ é€’ä¸€ç‚¹åŸºç¡€å‚æ•°ç»™è¿™ä¸ª HOCï¼Œå‰©ä¸‹çš„äº¤ç»™å®ƒå°±è¡Œï¼š

```js
// App.js
import withGuides from "./withGuides";

class App extends React.Component {
  constructor(props) {
    super(props);
  }

  render() {
    return (
      <div>
        {/* å…¶ä»–é¡µé¢å…ƒç´ */}
        <div id="guide">{/* éœ€è¦æŒ‡å¼•çš„å†…å®¹*/}</div>
      </div>
    );
  }
}

const guides = [
  {
    id: "only-guide-id",
    steps: [
      {
        name: "æ–‡æ¡ˆæ ‡é¢˜",
        title: "æ–‡æ¡ˆè¯¦æƒ…å†…å®¹~~~~",
        selector: "#guide",
        // ...å…¶ä»–é…ç½®å‚æ•°
      },
    ],
  },
];

export default withGuides(App, guides);
```

å¸Œæœ›ä½ çœ‹å®Œè¿™ç¯‡æ–‡ç« ä¹‹åèƒ½é‡æ–°è®¤è¯†ä¸€ç‚¹ HOC åˆ°åº•æ˜¯ä»€ä¹ˆï¼Œä»€ä¹ˆæ—¶å€™ä¼šç”¨åˆ°ï¼Œè¦æ€ä¹ˆä½¿ç”¨ã€‚å®ƒä¸å†æ˜¯ä¸€ä¸ªæ¯ç‡¥çš„é¢è¯•çŸ¥è¯†ç‚¹ï¼Œå› ä¸ºå¾ˆå¤šåº“å·²ç»è¯æ˜äº†å®ƒçš„ä¼˜ç§€ã€‚

### å‚è€ƒæ–‡çŒ®

- [Higher-Order Components](https://reactjs.org/docs/higher-order-components.html)

### æ¨èé˜…è¯»

- [æ·±å…¥ç†è§£ React é«˜é˜¶ç»„ä»¶](https://zhuanlan.zhihu.com/p/24776678)
- [React Higher Order Components in 3 minutes](https://codeburst.io/higher-order-components-in-3-minutes-93173b2ebe52)
